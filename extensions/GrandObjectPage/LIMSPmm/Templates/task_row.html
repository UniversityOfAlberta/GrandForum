<%
    var canEditThisRow = isEditMode && isAllowedToEdit;
    var isLeaderEditing = canEditThisRow && isLeaderAllowedToEdit;
    var allStatuses = statuses || {};
%>

<% if (isLeaderEditing) { %>
    <td valign="top"><span id="deleteTask" class="delete-icon" style="margin: 7px 5px 0 5px;" title="Delete Task"></span></td>
<% } %>

<td valign="top">
    <% if (isLeaderEditing) { %>
        <%= HTML.TextBox(this, 'task', {placeholder: 'Enter Task...', style: "width:100%;box-sizing:border-box;margin:0;"}) %>
    <% } else { %>
        <%= task %>
    <% } %>
</td>

<td valign="top">
    <% if (isLeaderEditing) { %>
        <% var taskTypesOptions = ['Planning', 'Screening', 'Data Extraction', 'Analysis and Report Writing']; %>
        <%= HTML.Select(this, 'taskType' , { options: taskTypesOptions }) %>
    <% } else { %>
        <%= taskType %>
    <% } %>
</td>

<td valign="top">
    <% if (isLeaderEditing) { %>
        <%
        var memberOptions = _.map(projectMembers, function(person) {
            return {option: person.fullName, value: person.id};
        });
        var allOptions = [
            {option: 'Everyone', value: -1}
        ].concat(memberOptions);
        %>
        <%= HTML.Select(this, 'assignees', { 
            style: 'width:200px;', 
            multiple: true, 
            options: allOptions
        }) %>
    <% } else { %>
        <% 
        var assigneesList = assignees || [];
        var isEveryoneAssigned = _.some(assigneesList, function(a) { return a.id === -1; });
        if (isEveryoneAssigned) { %>
            <div>Everyone</div>
        <% } else if (assigneesList.length > 0) {
            assigneesList.forEach(function(assignee) { %>
                <div><a href="<%= assignee.url %>"><%= assignee.name %></a></div>
            <% });
        } else { %>
            <div>No Assignees</div>
        <% } %>
    <% } %>
</td>

<td valign="top" style="white-space:nowrap;">
    <% if (isLeaderEditing) { %>
        <%= HTML.DatePicker(this, 'dueDate', { format: 'yy-mm-dd', style: 'width:5em'}) %>
    <% } else { %>
        <div style="text-align: center;"><%= dueDate %></div>
    <% } %>
</td>

<td style="text-align: center; white-space:nowrap; padding: 5px;">
    <% if (isLeaderAllowedToEdit) { %>
        <%
            var allAssignees = isEveryoneAssigned ? projectMembers : assignees;
            var isFullyCompleted = false;
            if (allAssignees && allAssignees.length > 0) {
                isFullyCompleted = _.every(allAssignees, function(assignee) {
                    return allStatuses[assignee.id] === 'Closed';
                });
            }
        %>
        <% if (isFullyCompleted) { %>
            <div style="color: #28a745; font-weight: bold;">Completed</div>
        <% } else { %>
            <div style="font-size: 12px; line-height: 1.6; text-align: left;">
                <div style="display: flex; align-items: center;">
                    <span style="width: 10px; height: 10px; background-color: #28a745; border-radius: 50%; margin-right: 6px;"></span>
                    <strong class="count-completed"><%= displayClosedCount %></strong>&nbsp;Completed
                </div>
                <div style="display: flex; align-items: center;">
                    <span style="width: 10px; height: 10px; background-color: #FF8C00; border-radius: 50%; margin-right: 6px;"></span>
                    <strong class="count-pending"><%= displayPendingReviewCount %></strong>&nbsp;Pending Review
                </div>
                <div style="display: flex; align-items: center;">
                    <span style="width: 10px; height: 10px; background-color: #007bff; border-radius: 50%; margin-right: 6px;"></span>
                    <strong class="count-assigned"><%= displayAssignedCount %></strong>&nbsp;Assigned
                </div>
            </div>
        <% } %>
        <% if (canEditThisRow) { %>
            <div style="margin-top: 5px;">
                <button id="changeStatusButton" type="button">Change Status</button>
            </div>
        <% } else { %>
            <div style="display: flex; flex-direction: column; gap: 5px; margin-top: 5px;">
                <button id="checkStatus" type="button" class="btn btn-primary btn-xs">Check Status</button>
                <button class="download-merged-files" data-format="csv" type="button" class="btn btn-primary btn-xs">Download Merged CSVs</button>
                <button class="download-merged-files" data-format="pdf" type="button" class="btn btn-primary btn-xs">Download Merged PDFs</button>            </div>
        <% }%>
    <% } else { %>
            <%
                var currentUserId = me.get('id');
                var reviewers = reviewers || {};
                var myStatus = 'Assigned'; // Default status
                var myAssigneeStatus = isCurrentUserAssignee ? (allStatuses[currentUserId] || allStatuses['-1']) : null;
                var reviewTaskStatus = null;
                if (isCurrentUserReviewer) {
                    var reviewedAssigneeId = _.findKey(reviewers, r => r && r.id == currentUserId);
                    if (reviewedAssigneeId) { reviewTaskStatus = allStatuses[reviewedAssigneeId]; }
                }
                if (myAssigneeStatus && myAssigneeStatus !== 'Closed') { myStatus = myAssigneeStatus; } 
                else if (isCurrentUserReviewer) { myStatus = (reviewTaskStatus === 'Done') ? 'Done' : 'Closed'; } 
                else { myStatus = myAssigneeStatus; }
            %>
            <% if (myStatus === 'Closed') { %>
                <div style="color: #28a745; font-weight: bold;">Completed</div>
            <% } else if (myStatus === 'Done') { %>
                <div style="color: #FF8C00; font-weight: bold; margin-bottom: 4px;">Pending Review</div>
                <div style="margin-top: 5px;">
                    <% if (canEditThisRow) { %>
                        <button id="changeStatusButton" type="button" class="btn btn-primary btn-xs">Change Status</button>
                    <% } else { %>
                        <button id="checkStatus" type="button" class="btn btn-primary btn-xs">Check Status</button>
                    <% } %>
                </div>
            <% } else { %>
                <div style="color: red; font-weight: bold; margin-bottom: 4px;">Pending</div>
                <div style="margin-top: 5px;">
                    <% if (canEditThisRow) { %>
                        <button id="changeStatusButton" type="button" class="btn btn-primary btn-xs">Change Status</button>
                    <% } else { %>
                        <button id="checkStatus" type="button" class="btn btn-primary btn-xs">Check Status</button>
                    <% } %>
                </div>
            <% } %>
        <% } %>
</td>
<td valign="top">
    <% if (isLeaderEditing) { %>
        <% var files = taskFiles || []; %>
        <% if (files.length > 0) { %>
            <div style="margin-bottom: 8px;">
                <% files.forEach(function(file, idx) { %>
                    <% var toDelete = file.delete || false; %>
                    <% if (!toDelete) { %>
                        <div style="margin-bottom: 4px;">
                            <a href="<%= file.url %>" target="_blank"><%= file.filename %></a>
                            <span class="delete-icon deleteTaskFile" data-file-id="<%= file.id %>" style="cursor: pointer;" title="Delete file"></span>
                        </div>
                    <% } %>
                <% }); %>
            </div>
        <% } %>
        <div>
            <%= HTML.File(this, 'newTaskFile', {}) %>
        </div>
    <% } else { %>
        <% var files = taskFiles || []; %>
        <% if (files.length > 0) { %>
            <% files.forEach(function(file) { %>
                <div><a href="<%= file.url %>" target="_blank"><%= file.filename %></a></div>
            <% }); %>
        <% } else { %>
            <span>No files</span>
        <% } %>
    <% } %>
</td>

<td valign="top">
    <% if (isLeaderEditing) { %>
        <%= HTML.TextArea(this, 'details', {style: "height: 63px;width:100%;box-sizing:border-box;margin:0;"}) %> 
    <% } else { %>
        <%= details %>
    <% } %>
</td>