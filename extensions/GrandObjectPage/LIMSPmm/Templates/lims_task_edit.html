<% if(this.model.opportunity.get('isAllowedToEdit')){ %>
    <td valign="top"><span id="deleteTask" class="delete-icon" style="margin: 7px 5px 0 5px;" title="Delete Task"></span></td>
    <td valign="top"><%= HTML.TextBox(this, 'task', {placeholder: 'Enter Task...', style: "width:100%;box-sizing:border-box;margin:0;"}) %></td>
    <% if(isLeaderAllowedToEdit){ %>   
    <%
    var taskTypesOptions = ['Planning', 'Screening', 'Data Extraction', 'Analysis and Report Writing'];
    %>
    <td valign="top">
        <%= HTML.Select(this, 'taskType' , { 
            options: taskTypesOptions
        }) %>
    </td>
     <% } else { %>
    <td valign="top"><%= taskType %></td>
    <% } %>
    <% if(isLeaderAllowedToEdit){ %>
        <%
        var memberOptions =  _.map(this.project.members.toJSON(), function(person) {
            return {option: person.fullName, value: person.id};
        })
        var allOptions = [
            {option: 'Everyone', value: -1}
        ].concat(memberOptions);
        %>
        <td valign="top">
            <%= HTML.Select(this, 'assignees', {
                style: 'width:200px; display: none',
                multiple: true,
                options: allOptions,
            }) %>
        </td>
    <% } else { %>
        <td>
            <% 
            var assigneesList = this.model.get('assignees'); // Assuming 'assignees' is an array of assignee objects
            if (assigneesList && assigneesList.length > 0) {
                assigneesList.forEach(function(assignee, index) {
                    %>
                    <div><a href="<%= assignee.url %>"><%= assignee.name %></a></div>
                    <% 
                });
            } else {
                %>
                <div>No Assignees</div>
                <%
            }
            %>
        </td>
    <% } %>
    <td valign="top" style="white-space:nowrap;"><%= HTML.DatePicker(this, 'dueDate', {format: 'yy-mm-dd', style: 'width:5em'}) %></td>
<% } else { %>
    <td><%= task %></td>
    <td><%= taskType %></td>
    <td>
        <% 
        var assigneesList = this.model.get('assignees'); // Assuming 'assignees' is an array of assignee objects
        if (assigneesList && assigneesList.length > 0) {
            var isEveryoneAssigned = this.model.get('isEveryoneAssigned');
            if (isEveryoneAssigned) { %>
                <div>Everyone</div>
            <% } else {
                assigneesList.forEach(function(assignee, index) {
                %>
                <div>
                    <a href="<%= assignee.url %>"><%= assignee.name %></a>
                </div>
                <% 
            });
            }
        } else {
            %>
            <div>No Assignees</div>
            <%
        }
        %>
    </td>
    <td style="text-align: center;"><%= dueDate %></td>
    
<% } %>

<td style="text-align: center; white-space:nowrap; padding: 5px;">
    <% if(isLeaderAllowedToEdit){ %>
        <%
            var allStatuses = this.model.get('statuses') || {};
            var allAssignees = this.model.get('assignees') || [];
            var isFullyCompleted = false;
            if (allAssignees.length > 0) {
                isFullyCompleted = _.every(allAssignees, function(assignee) {
                    var assigneeId = assignee.id || assignee;
                    return allStatuses[assigneeId] === 'Closed';
                });
            }
        %>
        <% if (isFullyCompleted) { %>
            <div style="text-align: center; color: #28a745; font-weight: bold; border-radius: 4px;">
                Completed
            </div>
            <div style="text-align: center; margin-top: 5px;">
                <button id="changeStatusButton" type="button">Change Status</button>
            </div>
            <div id="changeStatusDialog"></div>
        <% } else { %>
            <div>
                <div style="font-size: 12px; line-height: 1.6; margin-bottom: 5px;">
                    <div style="display: flex; align-items: center; white-space: nowrap;">
                        <span style="width: 10px; height: 10px; background-color: #28a745; border-radius: 50%; margin-right: 6px; flex-shrink: 0;"></span>
                        <strong class="count-completed" style="margin-right: 4px;"><%= displayClosedCount %></strong> Completed
                    </div>
                    <div style="display: flex; align-items: center; white-space: nowrap;">
                        <span style="width: 10px; height: 10px; background-color: #FF8C00; border-radius: 50%; margin-right: 6px; flex-shrink: 0;"></span>
                        <strong class="count-pending" style="margin-right: 4px;"><%= displayPendingReviewCount %></strong> Pending Review
                    </div>
                    <div style="display: flex; align-items: center; white-space: nowrap;">
                        <span style="width: 10px; height: 10px; background-color: #007bff; border-radius: 50%; margin-right: 6px; flex-shrink: 0;"></span>
                        <strong class="count-assigned" style="margin-right: 4px;"><%= displayAssignedCount %></strong> Assigned
                    </div>
                </div>
                <div style="text-align: center; margin-top: 5px;">
                    <button id="changeStatusButton" type="button">Change Status</button>
                </div>
                <div id="changeStatusDialog"></div>
            </div>
        <% } %>
    <% } else { %>
        <%
            var statuses = this.model.get('statuses') || {};
            var currentUserId = me.get('id');
            var reviewers = this.model.get('reviewers') || {};
            var myStatus = null;

            var isAssignee = this.model.get('isCurrentUserAssignee');
            var isReviewer = this.model.get('isCurrentUserReviewer');

            var myAssigneeStatus = null;
            if (isAssignee) {
                myAssigneeStatus = statuses[currentUserId] || statuses['-1'];
            }

            var reviewTaskStatus = null;
            if (isReviewer) {
                var reviewedAssigneeId = _.findKey(reviewers, function(reviewer) {
                    return reviewer && reviewer.id == currentUserId;
                });
                if (reviewedAssigneeId) {
                     reviewTaskStatus = statuses[reviewedAssigneeId];
                }
            }

            if (myAssigneeStatus && myAssigneeStatus !== 'Closed') {
                // Active assignee work is the priority.
                myStatus = myAssigneeStatus;
            } else if (isReviewer) {
                // If assignee work is done, check reviewer duties.
                if (reviewTaskStatus === 'Done') {
                    myStatus = 'Done';
                } else {
                    myStatus = 'Closed';
                }
            } else {
                myStatus = myAssigneeStatus;
            }            
            if (myStatus === null) {
                myStatus = 'Assigned';
            }

            if (myStatus === 'Closed') { 
            %>
            <div style="text-align: center; color: #28a745; font-weight: bold; border-radius: 4px;">
                Completed
            </div>
        <% } else if (myStatus === 'Done') { %>
            <div style="text-align: center; color: #FF8C00; font-weight: bold; border-radius: 4px;">
                Pending Review
            </div>
            <div style="text-align: center; margin-top: 5px;">
                <button id="changeStatusButton" type="button">Change Status</button>
            </div>
            <div id="changeStatusDialog"></div>
        <% } else { %>
            <div style="text-align: center; color: red; font-weight: bold; border-radius: 4px;">
                Pending
            </div>
            <div style="text-align: center; margin-top: 5px;">
                <button id="changeStatusButton" type="button">Change Status</button>
            </div>
            <div id="changeStatusDialog"></div>
        <% } %>
    <% } %>
</td>
<% if(isLeaderAllowedToEdit){ %>
    <td valign="top" style="white-space:nowrap; width:40%">
        <%= HTML.TextArea(this, 'details', {style: "height: 63px;width:100%;box-sizing:border-box;margin:0;"}) %> 
    </td>
<% } else { %>
    <td valign="top" style="width:40%">
        <%= details %>
    </td>
<% } %>

