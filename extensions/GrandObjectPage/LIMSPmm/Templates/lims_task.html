<td><%= task %></td>
<td><%= taskType %></td>
<td>
    <% 
    var assigneesList = this.model.get('assignees') || [];
    var isEveryoneAssigned = _.some(assigneesList, function(a) { return a.id === -1; });

    if (isEveryoneAssigned) { %>
        <div>Everyone</div>
    <% } else {
        if (assigneesList.length > 0) {
            assigneesList.forEach(function(assignee) { %>
                <div><a href="<%= assignee.url %>"><%= assignee.name %></a></div>
            <% });
        } else { %>
            <div>No Assignees</div>
        <% }
    } %>
</td>
<td style="text-align: center;"><%= dueDate %></td>
<td style="text-align: center; white-space:nowrap; padding: 5px;">
    <% 
    if (isLeaderAllowedToEdit) { %>
        <%
            var allStatuses = this.model.get('statuses') || {};
            var allAssignees = this.model.get('assignees') || [];
            var isFullyCompleted = false;
            if (allAssignees.length > 0) {
                isFullyCompleted = _.every(allAssignees, function(assignee) {
                    var assigneeId = assignee.id || assignee;
                    return allStatuses[assigneeId] === 'Closed';
                });
            }
        %>
        <% if (isFullyCompleted) { %>
            <div style="color: #28a745; font-weight: bold;">
                Completed
            </div>
        <% } else { %>
            <div style="font-size: 12px; line-height: 1.6; margin-bottom: 5px; text-align: left;">
                <div style="display: flex; align-items: center; white-space: nowrap;">
                    <span style="width: 10px; height: 10px; background-color: #28a745; border-radius: 50%; margin-right: 6px;"></span>
                    <strong style="margin-right: 4px;"><%= displayClosedCount %></strong> Completed
                </div>
                <div style="display: flex; align-items: center; white-space: nowrap;">
                    <span style="width: 10px; height: 10px; background-color: #FF8C00; border-radius: 50%; margin-right: 6px;"></span>
                    <strong style="margin-right: 4px;"><%= displayPendingReviewCount %></strong> Pending Review
                </div>
                <div style="display: flex; align-items: center; white-space: nowrap;">
                    <span style="width: 10px; height: 10px; background-color: #007bff; border-radius: 50%; margin-right: 6px;"></span>
                    <strong style="margin-right: 4px;"><%= displayAssignedCount %></strong> Assigned
                </div>
            </div>
        <% } %>
        <div style="display: flex; flex-direction: column; gap: 5px; margin-top: 5px;">
            <button id="checkStatus" type="button" class="btn btn-primary btn-xs">Check Status</button>
            <button class="download-merged-csvs" type="button" class="btn btn-primary btn-xs">Download CSVs</button>
        </div>

    <% } else if (isCurrentUserAssignee || isCurrentUserReviewer) { %>
        
        <%
            var statuses = this.model.get('statuses') || {};
            var currentUserId = me.get('id');
            var reviewers = this.model.get('reviewers') || {};
            var myStatus = null;

            var myAssigneeStatus = null;
            if (isCurrentUserAssignee) {
                myAssigneeStatus = statuses[currentUserId] || statuses['-1'];
            }

            var reviewTaskStatus = null;
            if (isCurrentUserReviewer) {
                var reviewedAssigneeId = _.findKey(reviewers, function(reviewer) {
                    return reviewer && reviewer.id == currentUserId;
                });
                if (reviewedAssigneeId) {
                     reviewTaskStatus = statuses[reviewedAssigneeId];
                }
            }

            if (myAssigneeStatus && myAssigneeStatus !== 'Closed') {
                myStatus = myAssigneeStatus;
            } else if (isCurrentUserReviewer) {
                if (reviewTaskStatus === 'Done') {
                    myStatus = 'Done';
                } else {
                    myStatus = 'Closed';
                }
            } else {
                myStatus = myAssigneeStatus;
            }
            if (myStatus === null) {
                myStatus = 'Assigned';
            }
            if (myStatus === 'Closed') { 
        %>
            <div style="color: #28a745; font-weight: bold;">
                Completed
            </div>
        <% } else if (myStatus === 'Done') { %>
            <div style="color: #FF8C00; font-weight: bold; margin-bottom: 4px;">
                Pending Review
            </div>
            <button id="checkStatus" type="button" class="btn btn-primary btn-xs">Check Status</button>
        <% } else { %>
            <div style="color: red; font-weight: bold; margin-bottom: 4px;">
                Pending
            </div>
            <button id="checkStatus" type="button" class="btn btn-primary btn-xs">Check Status</button>
        <% } %>
    <% } %>
</td>
<td>
    <%= details %>
</td>