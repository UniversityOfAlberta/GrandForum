<?xml version="1.0" encoding="UTF-8" ?>
<Report name=" " headerName=" " pageCount="false" reportType="RP_LETTER{GET(n, 1)}" pdfType="RP_LETTER{GET(n, 1)}" pdfFiles="Letters/Base" personId="{GET(userId, {$my_id})}" ajax="true" encrypt="true">
    <Permissions>
        <Role role="DEAN">
            <SectionPermission id="fec1" permissions="rw" />
            <SectionPermission id="fec2" permissions="rw" />
            <SectionPermission id="fec3" permissions="rw" />
            <SectionPermission id="fec4" permissions="rw" />
            <SectionPermission id="fec5" permissions="rw" />
            <SectionPermission id="atsec1" permissions="rw" />
            <SectionPermission id="atsec2" permissions="rw" />
            <SectionPermission id="atsec3" permissions="rw" />
            <SectionPermission id="atsec4" permissions="rw" />
            <SectionPermission id="letter" permissions="rw" />
        </Role>
        <Role role="VDEAN">
            <SectionPermission id="fec1" permissions="rw" />
            <SectionPermission id="fec2" permissions="rw" />
            <SectionPermission id="fec3" permissions="rw" />
            <SectionPermission id="fec4" permissions="rw" />
            <SectionPermission id="fec5" permissions="rw" />
            <SectionPermission id="atsec1" permissions="rw" />
            <SectionPermission id="atsec2" permissions="rw" />
            <SectionPermission id="atsec3" permissions="rw" />
            <SectionPermission id="atsec4" permissions="rw" />
            <SectionPermission id="letter" permissions="rw" />
        </Role>
        <Role role="HR">
            <SectionPermission id="fec1" permissions="rw" />
            <SectionPermission id="fec2" permissions="rw" />
            <SectionPermission id="fec3" permissions="rw" />
            <SectionPermission id="fec4" permissions="rw" />
            <SectionPermission id="fec5" permissions="rw" />
            <SectionPermission id="atsec1" permissions="rw" />
            <SectionPermission id="atsec2" permissions="rw" />
            <SectionPermission id="atsec3" permissions="rw" />
            <SectionPermission id="atsec4" permissions="rw" />
            <SectionPermission id="letter" permissions="rw" />
        </Role>
        <Role role="MANAGER+">
            <SectionPermission id="fec1" permissions="rw" />
            <SectionPermission id="fec2" permissions="rw" />
            <SectionPermission id="fec3" permissions="rw" />
            <SectionPermission id="fec4" permissions="rw" />
            <SectionPermission id="fec5" permissions="rw" />
            <SectionPermission id="atsec1" permissions="rw" />
            <SectionPermission id="atsec2" permissions="rw" />
            <SectionPermission id="atsec3" permissions="rw" />
            <SectionPermission id="atsec4" permissions="rw" />
            <SectionPermission id="letter" permissions="rw" />
        </Role>
        <Role role="CHAIR">
            <SectionPermission id="fec1" permissions="r" />
            <SectionPermission id="fec2" permissions="r" />
            <SectionPermission id="fec3" permissions="r" />
            <SectionPermission id="fec4" permissions="r" />
            <SectionPermission id="fec5" permissions="r" />
            <SectionPermission id="atsec1" permissions="r" />
            <SectionPermission id="atsec2" permissions="r" />
            <SectionPermission id="atsec3" permissions="r" />
            <SectionPermission id="atsec4" permissions="r" />
            <SectionPermission id="letter" permissions="r" />
        </Role>
    </Permissions>
    <ReportSection id="fec1" name="FEC Letter 1" title="FEC Letters Table" type="EditableReportSection" blobSection="TABLE" renderpdf="false">
        <Static>
            <![CDATA[
                <iframe id='downloadFrame' name='downloadFrame' src="" style="display:none;"></iframe>
                <div style='float:right; margin-top: -45px;display:flex;'>
                    <div><button id='generateAll' type='button'>Generate All Letters</button></div>
                    <div><button id='downloadAll' class='noDisable' type='button'>Download All Letters</button></div>
                </div>
                <script type='text/javascript'>
                    function postToIframe(data,url,target){
                        $('body').append('<form action="'+url+'" method="post" target="'+target+'" id="postToIframe"></form>');
                        $.each(data,function(n,v){
                            $('#postToIframe').append('<input type="hidden" name="'+n+'" value="'+v+'" />');
                        });
                        $('#postToIframe').submit().remove();
                    }
                    $('#generateAll').click(function(){
                        $('.generatePDF:not(:disabled)').click();
                    });
                    $('#downloadAll').click(function(){
                        var pdfs = $.makeArray($(".letterPDF:visible").map(function(i, pdf){ return $(pdf).attr('href');})).join(',').replaceAll(wgServer + wgScriptPath + '/index.php/Special:ReportArchive?getpdf=', '');
                        postToIframe({pdfs: pdfs}, wgServer + wgScriptPath + '/index.php?action=downloadReportZip&zipName=Letters.zip', 'downloadFrame');
                    });
                </script>
                <table id='letterTable' width='100%' class='wikitable' frame='box' rules='all'>
                    <thead>
                        <tr>
                            <th>Case#</th>
                            <th>Name</th>
                            <th>Department</th>
                            <th>PDF</th>
                            <th style='width:14em;'>Generate</th>
                            <th>Template</th>
                            <th>Date</th>
                            <th>Comments</th>
                            <th>Location</th>
                            <th>Show 0D Message</th>
                            <th>Chair Position</th>
                            <th>Chair (From)</th>
                    </thead>
                    <tbody>
            ]]>
        </Static>
        <ReportItemSet id="faculty" type="FacultyPeopleReportItemSet" includeDean="true" start="{$last_year}-07-01" end="{$this_year}-07-01">
            <If if="{or({contains({$my_roles},ADMIN)},
                        {contains({$my_roles},DEAN)},
                        {contains({$my_roles},VDEAN)},
                        {contains({$my_roles},HR)},
                        {and(
                            {contains({$my_roles},CHAIR)},
                            {==({$my_dept},{$user_dept})}
                        )}
                    )}">
                <Static>
                    <![CDATA[
                        <tr data-fecid="{getExtra()}" data-userid="{$user_id}">
                            <td>{getExtra()}</td>
                            <td><a href="{$user_url}" target="_blank">{$user_name}</a></td>
                            <td>{$user_dept}</td>
                    ]]>
                </Static>
                <ReportItem id="letter" type="PDFReportItem" class="letterPDF downloadButton{$user_id}" reportType="Letters/Base" pdfReport="{$report_type}" buttonName="&lt;img src='{$wgServer}{$wgScriptPath}/skins/pdf.gif' />">
                    <![CDATA[
                            <td align='center'>
                                {$item}
                            </td>
                            <td style='white-space:nowrap;' align='center'>
                                <input class='generatePDF' type='button' value="Generate PDF" />
                                <img class="throbber" style="display: none; vertical-align: -20%;" src="../skins/Throbber.gif"><br />
                                <a style='cursor: pointer;' class='preview'>Preview</a>
                            </td>
                    ]]>
                </ReportItem>
                <ReportItem id="template" type="Select" personId="1" blobItem="TEMPLATE" blobSubItem="{$user_id}" width="3em" options="|7|8|9|10|11|12|13|14|15|16|17|18|19|20|21|22|23|24|25|26|27|28|29|30|31|32|33|34|35|36|37|38|39|40|41|42|43|44|45|50|51|X" labels="|07 - Department Chair recommends 2nd probationary period, FEC agrees - Article A5.03.2(a) or A5.03.4(a)|08 - Department Chair recommends tenure, FEC awards 2nd probationary period - Article 5.03.4(a)|09 - Department Chair recommends tenure, FEC agree - Article A5.03.4|10 - Department Chair recommends no further appointment - Article A5.03.1(c) (Possible Contested Case)|11 - Dean recommends no further appointment - Article A5.03.1(c) (Possible Contested Case)|12 - Department Chair recommends tenure, FECs preliminary position is no further appointment - Article A5.03.4 (c) (Possible Reconsideration)|13 - Department Chair recommends no further appointment, staff member contests, FEC agrees with recommendation - Article A5.03.4(c) (Possible GAC)|14 - Department Chair recommends tenure and FEC agrees - A5.04.2(a)|15 - Department Chair recommends a one-year extension and FEC agrees - A5.04.2(c)|16 - Department Chair recommends tenure and FEC awards an one-year extension - A5.04.2(c)|17 - Department Chair recommends tenure, FEC preliminary position is no further appointment be offered - A5.04.2(b) (Possible Reconsideration Case)|18 - Department Chair recommends 1 year extension, FEC preliminary position is no further appointment be offered - A5.04.2(b) (Possible Reconsideration Case)|19 - Department Chair recommends no further appointment - A5.04.1(b) (Possible Contested Case)|20 - FEC reconsideration meeting upholds preliminary decision to award no further appointment - A6.21.5(h) and A6.16.7|21 - FEC awards tenure after member contests Department Chair's recommendation to not support tenure - A6.18.12 and A6.16.7|22 - Department Chair recommends promotion - A6.14.1(b)|23 - Department Chair does not recommend promotion - A6.14.1(b) (Possible Contested Case)|24 - Department Chair recommends promotion and FEC agrees - A6.16.5(a)|25 - Department Chair does not recommend promotion and FEC awards promotion - A6.16.5(b)|26 - Department Chair recommends promotion and FEC denies promotion - A6.19.1(b) (Possible Reconsideration Case)|27 - Department Chair does not recommend promotion, staff member appears before FEC to contest, and FEC denies promotion - A6.18.12 and A6.16.7 (Possible GAC Case)|28 - New appointment between July 1 and October 1 (inclusive) - A6.11.1|29 - New appointment between October 2 and June 1 (inclusive) - A6.11.2|30 - Department Chair recommends ≥ 1.0 - A6.14.1(a)|31 - FEC supports Department Chair’s recommended incrementation of > 1.0 - A6.16.5(a)|32 - FEC awards higher incrementation than Department Chair’s recommendation - A6.16.5(b)|33 - FEC awards lower incrementation than Department Chair’s recommendation but award is still > 1.0 - A6.16.5(b)|34 - After reconsideration, FEC awards lower incrementation than Department Chair’s recommendation - A6.21.5(h) and A6.16.7 (Possible GAC Case)|35 - Department Chair recommends &lt;1.0 - A6.14.1 (Possible Contested Case)|36 - Department Chair recommends &lt;1, staff member did not contest, FEC reduces incrementation even lower - A6.18.12 and A6.16.7 (Possible Reconsideration Case)|37 - Department Chair recommends &lt;1.0, staff member contests, FEC agrees with recommendation - A6.18.12 and A6.16.7 (Possible GAC Case)|38 - FEC agrees with Department Chair’s recommendation of &lt;1.0, staff member does not contest - A6.16.5(a)|39 - Department Chair recommends > 1.0 incrementation, FEC awards &lt;1.0 incrementation - A6.16.5(b) (Possible Reconsideration Case)|40 - Department Chair recommends 1.0, FECs preliminary position awarded &lt;1.0, staff member has case reconsidered, FEC decision remains &lt;1.0 - A6.21.5(h) and A6.16.7 (Possible GAC Case)|41 - Department Chair recommends 0d for the second time in three years - A6.14(a)| 42 - Department Chair recommends a 0b, 0.50, or 0.75, staff member does not contest, FEC awards 0d incrementation - A6.16.5(b) (Possible Reconsideration Case)|43 - FEC recommends approval of sabbatical, Dean accepts the FEC recommendation - A4.02.4|44 - FEC recommends approval of sabbatical, Dean denies due to being over quota - A4.02.4 and A4.02.8|45 - FEC does not recommend approval of sabbatical, Dean denies application - A4.02.4|50 - Promotion to FSO III|51 - Promotion to FSO IV|0X - Dean recommends increment and FEC agrees">
                    <![CDATA[
                            <td align="center" class="template">
                                {$item}
                            </td>
                    ]]>
                </ReportItem>
                <ReportItem id="followup_date" type="Text" personId="1" blobItem="FOLLOWUP_DATE" blobSubItem="{$user_id}" width="9em">
                    <![CDATA[
                            <td align="center">
                                {$item}
                            </td>
                    ]]>
                </ReportItem>
                <ReportItem id="comment" type="Textarea" personId="1" blobItem="COMMENT" blobSubItem="{$user_id}" height="50px" width="200px">
                    <![CDATA[
                            <td align="center">
                                {$item}
                            </td>
                    ]]>
                </ReportItem>
                <ReportItem id="location" type="Text" personId="1" blobItem="LOCATION" blobSubItem="{$user_id}" width="9em">
                    <![CDATA[
                            <td align="center">
                                {$item}
                            </td>
                    ]]>
                </ReportItem>
                <ReportItem id="0d" type="Select" personId="1" blobItem="0D" blobSubItem="{$user_id}" options="|Yes|No" width="4em">
                    <![CDATA[
                            <td align="center">
                                {$item}
                            </td>
                    ]]>
                </ReportItem>
                <ReportItem id="chair_position" type="Select" personId="1" blobItem="CHAIR_POSITION" blobSubItem="{$user_id}" options="|continues to support their original recommendation|now supports the preliminary position of FEC|was|wasn't|supported|not supported">
                    <![CDATA[
                            <td align="center">
                                {$item}
                            </td>
                    ]]>
                </ReportItem>
                <ReportItem id="chair" type="Text" personId="1" blobItem="CHAIR" blobSubItem="{$user_id}">
                    <![CDATA[
                            <td align="center">
                                {$item}
                            </td>
                    ]]>
                </ReportItem>
                <Static>
                    <![CDATA[
                        </tr>
                    ]]>
                </Static>
            </If>
        </ReportItemSet>
        <Static>
            <![CDATA[
                    </tbody>
                </table>
                <script type="text/javascript">
                    var table = $('#letterTable').DataTable({
                        "lengthMenu": [[10, 25, 50, -1], [10, 25, 50, "All"]],
                        "iDisplayLength": -1,
                        "scrollX": true,
                        "scrollY": 500
                    });
                    $(".template").change(function(){
                        if($("option:selected", $(this)).val() == ""){
                            $(".generatePDF", $(this).closest("tr")).prop("disabled", true);
                            $(".preview", $(this).closest("tr")).hide();
                        }
                        else{
                            $(".generatePDF", $(this).closest("tr")).prop("disabled", false);
                            $(".preview", $(this).closest("tr")).show();
                        }
                    }).trigger("change");
                    $('#letterTable select, #letterTable textarea, #letterTable input').change(function(){
                        saveAll();
                    });
                    $('#letterTable a.preview').click(function(){
                        var userid = $(this).closest("tr").attr("data-userid");
                        var template = $(".template select option:selected", $(this).closest("tr")).val();
                        
                        var url = wgServer + wgScriptPath + "/index.php/Special:Report?report=Letters/" + template + 
                                                            "&n=" + "{$report_type}".slice(-1) + 
                                                            "&userId=" + userid + 
                                                            "&generatePDF&preview&dpi=100";
                        saveAll(function(){
                            window.open(url,"Preview",'height=720,width=825');
                        });
                    });
                    $('#letterTable input.generatePDF').click(function(){
                        var userid = $(this).closest("tr").attr("data-userid");
                        var template = $(".template select option:selected", $(this).closest("tr")).val();
                        $(this).prop("disabled", true);
                        $(this).siblings(".throbber").show();
                        saveAll(function(){
                            if(template != ""){
                                $.get(wgServer + wgScriptPath + "/index.php/Special:Report?report=Letters/" + template + 
                                                                "&n=" + "{$report_type}".slice(-1) + 
                                                                "&userId=" + userid + 
                                                                "&generatePDF", function(response){
                                    $(".downloadButton" + userid).attr("href", wgServer + wgScriptPath + "/index.php/Special:ReportArchive?getpdf=" + response["Letters/" + template].tok).show();
                                    $(this).prop("disabled", false);
                                    $(this).siblings(".throbber").hide();
                                }.bind(this));
                            }
                            else{
                                $(this).prop("disabled", false);
                                $(this).siblings(".throbber").hide();
                            }
                        }.bind(this));
                    });
                </script>
            ]]>
        </Static>
    </ReportSection>
    <ReportSection id="fec2" name="FEC Letter 2" blobReport="RP_LETTER2" copy="fec1" />
    <ReportSection id="fec3" name="FEC Letter 3" blobReport="RP_LETTER3" copy="fec1" />
    <ReportSection id="fec4" name="FEC Letter 4" blobReport="RP_LETTER4" copy="fec1" />
    <ReportSection id="fec5" name="FEC Variance" blobReport="RP_LETTER5" title="FEC Letters Table" type="EditableReportSection" blobSection="TABLE" renderpdf="false">
        <Static>
            <![CDATA[
                <iframe id='downloadFrame' name='downloadFrame' src="" style="display:none;"></iframe>
                <div style='float:right; margin-top: -45px;display:flex;'>
                    <div><button id='generateAll' type='button'>Generate All Letters</button></div>
                    <div><button id='downloadAll' class='noDisable' type='button'>Download All Letters</button></div>
                </div>
                <script type='text/javascript'>
                    function postToIframe(data,url,target){
                        $('body').append('<form action="'+url+'" method="post" target="'+target+'" id="postToIframe"></form>');
                        $.each(data,function(n,v){
                            $('#postToIframe').append('<input type="hidden" name="'+n+'" value="'+v+'" />');
                        });
                        $('#postToIframe').submit().remove();
                    }
                    $('#generateAll').click(function(){
                        $('.generatePDF:not(:disabled)').click();
                    });
                    $('#downloadAll').click(function(){
                        var pdfs = $.makeArray($(".letterPDF:visible").map(function(i, pdf){ return $(pdf).attr('href');})).join(',').replaceAll(wgServer + wgScriptPath + '/index.php/Special:ReportArchive?getpdf=', '');
                        postToIframe({pdfs: pdfs}, wgServer + wgScriptPath + '/index.php?action=downloadReportZip&zipName=Letters.zip', 'downloadFrame');
                    });
                </script>
                <table id='letterTable' width='100%' class='wikitable' frame='box' rules='all'>
                    <thead>
                        <tr>
                            <th>Case#</th>
                            <th>Name</th>
                            <th>Department</th>
                            <th>PDF</th>
                            <th style='width:14em;'>Generate</th>
                            <th>Template</th>
                            <th>From</th>
                            <th>Role</th>
                            <th>Replace Role</th>
                            <th>Teaching</th>
                            <th>Research</th>
                            <th>Service</th>
                            <th>Admin</th>
                            <th>Start Date</th>
                            <th>End Date</th>
                    </thead>
                    <tbody>
            ]]>
        </Static>
        <ReportItemSet id="faculty" type="FacultyPeopleReportItemSet" includeDean="true" start="{$last_year}-07-01" end="{$this_year}-07-01">
            <If if="{or({contains({$my_roles},ADMIN)},
                        {contains({$my_roles},DEAN)},
                        {contains({$my_roles},VDEAN)},
                        {contains({$my_roles},HR)},
                        {and(
                            {contains({$my_roles},CHAIR)},
                            {==({$my_dept},{$user_dept})}
                        )}
                    )}">
                <Static>
                    <![CDATA[
                        <tr data-fecid="{getExtra()}" data-userid="{$user_id}">
                            <td>{getExtra()}</td>
                            <td><a href="{$user_url}" target="_blank">{$user_name}</a></td>
                            <td>{$user_dept}</td>
                    ]]>
                </Static>
                <ReportItem id="letter" type="PDFReportItem" class="letterPDF downloadButton{$user_id}" reportType="Letters/Base" pdfReport="{$report_type}" buttonName="&lt;img src='{$wgServer}{$wgScriptPath}/skins/pdf.gif' />">
                    <![CDATA[
                            <td align='center'>
                                {$item}
                            </td>
                            <td style='white-space:nowrap;' align='center'>
                                <input class='generatePDF' type='button' value="Generate PDF" />
                                <img class="throbber" style="display: none; vertical-align: -20%;" src="../skins/Throbber.gif"><br />
                                <a style='cursor: pointer;' class='preview'>Preview</a>
                            </td>
                    ]]>
                </ReportItem>
                <ReportItem id="template" type="Select" personId="1" blobItem="TEMPLATE" blobSubItem="{$user_id}" options="|Variance" labels="|Variance" width="6em">
                    <![CDATA[
                            <td align="center" class="template">
                                {$item}
                            </td>
                    ]]>
                </ReportItem>
                <ReportItem id="from" type="Text" personId="1" blobItem="FROM" blobSubItem="{$user_id}" width="9em">
                    <![CDATA[
                            <td align="center">
                                {$item}
                            </td>
                    ]]>
                </ReportItem>
                <ReportItem id="role" type="Text" personId="1" blobItem="ROLE" blobSubItem="{$user_id}" width="9em">
                    <![CDATA[
                            <td align="center">
                                {$item}
                            </td>
                    ]]>
                </ReportItem>
                <ReportItem id="replace_role" type="Select" options="|Yes" personId="1" blobItem="REPLACE_ROLE" blobSubItem="{$user_id}" width="9em">
                    <![CDATA[
                            <td align="center">
                                {$item}
                            </td>
                    ]]>
                </ReportItem>
                <ReportItem id="teaching" type="Text" personId="1" blobItem="TEACHING" blobSubItem="{$user_id}" width="28px">
                    <![CDATA[
                            <td align="center">
                                {$item}
                            </td>
                    ]]>
                </ReportItem>
                <ReportItem id="research" type="Text" personId="1" blobItem="RESEARCH" blobSubItem="{$user_id}" width="28px">
                    <![CDATA[
                            <td align="center">
                                {$item}
                            </td>
                    ]]>
                </ReportItem>
                <ReportItem id="service" type="Text" personId="1" blobItem="SERVICE" blobSubItem="{$user_id}" width="28px">
                    <![CDATA[
                            <td align="center">
                                {$item}
                            </td>
                    ]]>
                </ReportItem>
                <ReportItem id="admin" type="Text" personId="1" blobItem="ADMIN" blobSubItem="{$user_id}" width="28px">
                    <![CDATA[
                            <td align="center">
                                {$item}
                            </td>
                    ]]>
                </ReportItem>
                <ReportItem id="start_date" type="Text" personId="1" blobItem="START_DATE" blobSubItem="{$user_id}" width="82px">
                    <![CDATA[
                            <td align="center">
                                {$item}
                            </td>
                    ]]>
                </ReportItem>
                <ReportItem id="end_date" type="Text" personId="1" blobItem="END_DATE" blobSubItem="{$user_id}" width="82px">
                    <![CDATA[
                            <td align="center">
                                {$item}
                            </td>
                    ]]>
                </ReportItem>
                <Static>
                    <![CDATA[
                        </tr>
                    ]]>
                </Static>
            </If>
        </ReportItemSet>
        <Static>
            <![CDATA[
                    </tbody>
                </table>
                <script type="text/javascript">
                    var table = $('#letterTable').DataTable({
                        "lengthMenu": [[10, 25, 50, -1], [10, 25, 50, "All"]],
                        "iDisplayLength": -1,
                        "scrollX": true,
                        "scrollY": 500
                    });
                    $(".template").change(function(){
                        if($("option:selected", $(this)).val() == ""){
                            $(".generatePDF", $(this).closest("tr")).prop("disabled", true);
                            $(".preview", $(this).closest("tr")).hide();
                        }
                        else{
                            $(".generatePDF", $(this).closest("tr")).prop("disabled", false);
                            $(".preview", $(this).closest("tr")).show();
                        }
                    }).trigger("change");
                    $('#letterTable select, #letterTable textarea, #letterTable input').change(function(){
                        saveAll();
                    });
                    $('#letterTable a.preview').click(function(){
                        var userid = $(this).closest("tr").attr("data-userid");
                        var template = $(".template select option:selected", $(this).closest("tr")).val();
                        
                        var url = wgServer + wgScriptPath + "/index.php/Special:Report?report=Letters/" + template + 
                                                            "&n=" + "{$report_type}".slice(-1) + 
                                                            "&userId=" + userid + 
                                                            "&generatePDF&preview&dpi=100";
                        saveAll(function(){
                            window.open(url,"Preview",'height=720,width=825');
                        });
                    });
                    $('#letterTable input.generatePDF').click(function(){
                        var userid = $(this).closest("tr").attr("data-userid");
                        var template = $(".template select option:selected", $(this).closest("tr")).val();
                        $(this).prop("disabled", true);
                        $(this).siblings(".throbber").show();
                        saveAll(function(){
                            if(template != ""){
                                $.get(wgServer + wgScriptPath + "/index.php/Special:Report?report=Letters/" + template + 
                                                                "&n=" + "{$report_type}".slice(-1) + 
                                                                "&userId=" + userid + 
                                                                "&generatePDF", function(response){
                                    $(".downloadButton" + userid).attr("href", wgServer + wgScriptPath + "/index.php/Special:ReportArchive?getpdf=" + response["Letters/" + template].tok).show();
                                    $(this).prop("disabled", false);
                                    $(this).siblings(".throbber").hide();
                                }.bind(this));
                            }
                            else{
                                $(this).prop("disabled", false);
                                $(this).siblings(".throbber").hide();
                            }
                        }.bind(this));
                    });
                </script>
            ]]>
        </Static>
    </ReportSection>
    <ReportSection id="atsec1" name="ATSEC Letter 1" title="ATSEC Letters Table" type="EditableReportSection" blobSection="TABLE" renderpdf="false">
        <Static>
            <![CDATA[
                <iframe id='downloadFrame' name='downloadFrame' src="" style="display:none;"></iframe>
                <div style='float:right; margin-top: -45px;display:flex;'>
                    <div><button id='generateAll' type='button'>Generate All Letters</button></div>
                    <div><button id='downloadAll' class='noDisable' type='button'>Download All Letters</button></div>
                </div>
                <script type='text/javascript'>
                    function postToIframe(data,url,target){
                        $('body').append('<form action="'+url+'" method="post" target="'+target+'" id="postToIframe"></form>');
                        $.each(data,function(n,v){
                            $('#postToIframe').append('<input type="hidden" name="'+n+'" value="'+v+'" />');
                        });
                        $('#postToIframe').submit().remove();
                    }
                    $('#generateAll').click(function(){
                        $('.generatePDF:not(:disabled)').click();
                    });
                    $('#downloadAll').click(function(){
                        var pdfs = $.makeArray($(".letterPDF:visible").map(function(i, pdf){ return $(pdf).attr('href');})).join(',').replaceAll(wgServer + wgScriptPath + '/index.php/Special:ReportArchive?getpdf=', '');
                        postToIframe({pdfs: pdfs}, wgServer + wgScriptPath + '/index.php?action=downloadReportZip&zipName=Letters.zip', 'downloadFrame');
                    });
                </script>
                <table id='letterTable' width='100%' class='wikitable' frame='box' rules='all'>
                    <thead>
                        <tr>
                            <th>Case#</th>
                            <th>Name</th>
                            <th>PDF</th>
                            <th style='width:14em;'>Generate</th>
                            <th>Template</th>
                            <th>Date</th>
                            <th>Comments</th>
                            <th>Chair Position</th>
                            <th>Promotion Rank</th>
                    </thead>
                    <tbody>
            ]]>
        </Static>
        <ReportItemSet id="faculty" type="FacultyPeopleReportItemSet" atsec="true" includeDean="true" start="{$last_year}-07-01" end="{$this_year}-07-01">
            <Static>
                <![CDATA[
                    <tr data-fecid="{getExtra()}" data-userid="{$user_id}">
                        <td>{getExtra()}</td>
                        <td><a href="{$user_url}" target="_blank">{$user_name}</a></td>
                ]]>
            </Static>
            <ReportItem id="letter" type="PDFReportItem" class="letterPDF downloadButton{$user_id}" reportType="Letters/Base" pdfReport="{$report_type}" buttonName="&lt;img src='{$wgServer}{$wgScriptPath}/skins/pdf.gif' />">
                <![CDATA[
                        <td align='center'>
                            {$item}
                        </td>
                        <td style='white-space:nowrap;' align='center'>
                            <input class='generatePDF' type='button' value="Generate PDF" />
                            <img class="throbber" style="display: none; vertical-align: -20%;" src="../skins/Throbber.gif"><br />
                            <a style='cursor: pointer;' class='preview'>Preview</a>
                        </td>
                ]]>
            </ReportItem>
            <ReportItem id="template" type="Select" personId="1" blobItem="TEMPLATE" blobSubItem="{$user_id}" width="3em" options="|ATS11|ATS12|ATS13|ATS14|ATS15|ATS16|ATS17|ATS18|ATS19|ATS20" labels="|11 - Agree with Chair (1.0 or Higher)|12 - Contestable from ATSEC|13 - Higher than Recommendation|14 - Lower but not less than 1.0|15 - 0A|16 - 0B|17 - 0C|18 - 0D|19 - Promotion|20 - Agree for Lower than 1">
                <![CDATA[
                        <td align="center" class="template">
                            {$item}
                        </td>
                ]]>
            </ReportItem>
            <ReportItem id="followup_date" type="Text" personId="1" blobItem="FOLLOWUP_DATE" blobSubItem="{$user_id}" width="9em">
                <![CDATA[
                        <td align="center">
                            {$item}
                        </td>
                ]]>
            </ReportItem>
            <ReportItem id="comment" type="Textarea" personId="1" blobItem="COMMENT" blobSubItem="{$user_id}" height="50px" width="200px">
                <![CDATA[
                        <td align="center">
                            {$item}
                        </td>
                ]]>
            </ReportItem>
            <ReportItem id="chair_position" type="Select" personId="1" blobItem="CHAIR_POSITION" blobSubItem="{$user_id}" options="|continues to support their original recommendation|now supports the preliminary position of FEC">
                <![CDATA[
                        <td align="center">
                            {$item}
                        </td>
                ]]>
            </ReportItem>
            <ReportItem id="promotion" type="Select" personId="1" blobItem="PROMOTION" blobSubItem="{$user_id}" options="|Associate Lecturer|Full Lecturer">
                <![CDATA[
                        <td align="center">
                            {$item}
                        </td>
                ]]>
            </ReportItem>
            <Static>
                <![CDATA[
                    </tr>
                ]]>
            </Static>
        </ReportItemSet>
        <Static>
            <![CDATA[
                    </tbody>
                </table>
                <script type="text/javascript">
                    var table = $('#letterTable').DataTable({
                        "lengthMenu": [[10, 25, 50, -1], [10, 25, 50, "All"]],
                        "iDisplayLength": -1,
                        "scrollX": true,
                        "scrollY": 500
                    });
                    $(".template").change(function(){
                        if($("option:selected", $(this)).val() == ""){
                            $(".generatePDF", $(this).closest("tr")).prop("disabled", true);
                            $(".preview", $(this).closest("tr")).hide();
                        }
                        else{
                            $(".generatePDF", $(this).closest("tr")).prop("disabled", false);
                            $(".preview", $(this).closest("tr")).show();
                        }
                    }).trigger("change");
                    $('#letterTable select, #letterTable textarea, #letterTable input').change(function(){
                        saveAll();
                    });
                    $('#letterTable a.preview').click(function(){
                        var userid = $(this).closest("tr").attr("data-userid");
                        var template = $(".template select option:selected", $(this).closest("tr")).val();
                        
                        var url = wgServer + wgScriptPath + "/index.php/Special:Report?report=Letters/" + template + 
                                                            "&n=" + "{$report_type}".slice(-1) + 
                                                            "&userId=" + userid + 
                                                            "&generatePDF&preview&dpi=100";
                        saveAll(function(){
                            window.open(url,"Preview",'height=720,width=825');
                        });
                    });
                    $('#letterTable input.generatePDF').click(function(){
                        var userid = $(this).closest("tr").attr("data-userid");
                        var template = $(".template select option:selected", $(this).closest("tr")).val();
                        $(this).prop("disabled", true);
                        $(this).siblings(".throbber").show();
                        saveAll(function(){
                            if(template != ""){
                                $.get(wgServer + wgScriptPath + "/index.php/Special:Report?report=Letters/" + template + 
                                                                "&n=" + "{$report_type}".slice(-1) + 
                                                                "&userId=" + userid + 
                                                                "&generatePDF", function(response){
                                    $(".downloadButton" + userid).attr("href", wgServer + wgScriptPath + "/index.php/Special:ReportArchive?getpdf=" + response["Letters/" + template].tok).show();
                                    $(this).prop("disabled", false);
                                    $(this).siblings(".throbber").hide();
                                }.bind(this));
                            }
                            else{
                                $(this).prop("disabled", false);
                                $(this).siblings(".throbber").hide();
                            }
                        }.bind(this));
                    });
                </script>
            ]]>
        </Static>
    </ReportSection>
    <ReportSection id="letter" tooltip="Letter" name="Letter" title="" blobSection="LETTER" type="HeaderReportSection" pagebreak="false">
        <Static id="header">
            <![CDATA[
                <style>
                    #pdfBody p {
                        margin-bottom: 1em;
                    }
                </style>
                <table style="width: 100%; margin-top: -2em;" cellspacing="0" cellpadding="0">
                    <tr>
                        <td align="left">
                            <div class='previewnodisplay'><img src='skins/UAlberta_Black.png' style='height: 4em;' /></div>
                            <div class='generatenodisplay'><img src='{$wgServer}{$wgScriptPath}/skins/UAlberta_Black.png' style='height: 4em;' /></div>
                        </td>
                        <td align="right">
                            <div class='previewnodisplay' style='margin-left: 3em; margin-top: 1em;'><img src='skins/LetterTitle.png' style='height: 4em;' /></div>
                            <div class='generatenodisplay' style='margin-left: 3em; margin-top: 1em;'><img src='{$wgServer}{$wgScriptPath}/skins/LetterTitle.png' style='height: 4em;' /></div>
                        </td>
                    </tr>
                </table>
                <hr style='border-width: 0.1em;' />
                <div style="font-size: 1.25em;display:inline-block;">
                <table style="width: 100%;" cellspacing="0" cellpadding="0">
                    <tr>
                        <td align="left">
                            <b>Faculty of Science</b><br />
                            Office of the Dean<br />
                            6-189 Centennial Centre for Interdisciplinary Science (CCIS)<br />
                            Edmonton, AB, Canada T6G 2E1
                        </td>
                        <td align="right">
                            <b>T</b> 780.492.4757<br />
                            <b>F</b> 780.492.9434<br />
                            dean.science@ualberta.ca<br />
                            www.ualberta.ca/science
                        </td>
                    </tr>
                </table>
                <br /><br />
                <table cellspacing="0" cellpadding="0">
                    <tr>
                        <td valign="top">Date:&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</td>
                        <td valign="top">{$date}<div style='height:0.25em;' /></td>
                    </tr>
                    <tr>
                        <td valign="top">To:</td>
                        <td valign="top">{$user_first_name} {$user_last_name}, {$user_dept}<div style='height:0.25em;' /></td>
                    </tr>
                    <tr>
                        <td valign="top">From:</td>
                        <td valign="top">
            ]]>
        </Static>
        <Static id="from">
            <![CDATA[
                            Eleni Stroulia<br />
                            Vice Dean of Science<br />
                            Chair Faculty Evaluation Committee
            ]]>
        </Static>
        <Static>
            <![CDATA[
                            <div style='height:0.25em;' />
                        </td>
                    </tr>
                    <tr>
                        <td valign="top">Cc:</td>
                        <td valign="top">
            ]]>
        </Static>
        <Static id="cc">
            <![CDATA[
                            Department Chair<br />
                            Faculty Personnel File
            ]]>
        </Static>
        <Static>
            <![CDATA[
                            <div style='height:0.25em;' />
                        </td>
                    </tr>
                    <tr>
                        <td valign="top">Re:</td>
                        <td valign="top"><b>{$section_title}</b></td>
                    </tr>
                </table><br /><br />
            ]]>
        </Static>
        <Static id="body">
            <![CDATA[
                <span></span>
            ]]>
        </Static>
        <If id="bodyset" if="{==(1,1)}">

        </If>
        <Static id="footer">
            <![CDATA[
                Sincerely,<br />
                <br />
                <div class='previewnodisplay'><img src='skins/Signature2.png' style='height: 3em;' /></div>
                <div class='generatenodisplay'><img src='{$wgServer}{$wgScriptPath}/skins/Signature2.png' style='height: 3em;' /></div>
                <br />
                Eleni Stroulia<br />
                Vice Dean of Science<br />
                Chair of the Science Faculty Evaluation Committee
                </div>
            ]]>
        </Static>
    </ReportSection>
    <ReportSection id="atsec2" name="ATSEC Letter 2" blobReport="RP_LETTER2" copy="atsec1" />
    <ReportSection id="atsec3" name="ATSEC Letter 3" blobReport="RP_LETTER3" copy="atsec1" />
    <ReportSection id="atsec4" name="ATSEC Letter 4" blobReport="RP_LETTER4" copy="atsec1" />
</Report>
